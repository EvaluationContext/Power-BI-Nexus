name: Issue and PR Management

on:
  issues:
    types: [opened, labeled]
  pull_request_target:
    types: [opened, ready_for_review]

permissions:
  issues: write
  pull-requests: write

jobs:
  welcome:
    name: Welcome New Contributors
    runs-on: ubuntu-latest
    steps:
      - name: Welcome first-time contributors
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue || context.payload.pull_request;
            const isFirstTime = context.payload.action === 'opened';
            
            if (!isFirstTime) return;
            
            // Check if this is truly their first contribution
            const creator = issue.user.login;
            const repo = context.repo;
            
            const { data: issues } = await github.rest.issues.listForRepo({
              ...repo,
              creator: creator,
              state: 'all'
            });
            
            if (issues.length === 1) {
              const welcomeMessage = context.payload.issue ? 
                `üëã Welcome to Power BI Nexus, @${creator}! Thanks for opening your first issue.
                
A maintainer will review your submission soon. In the meantime:
- ‚úÖ Make sure you've filled out all required fields
- ‚úÖ Check our [Contributing Guidelines](../CONTRIBUTING.md)
- ‚úÖ Join the [Discussions](https://github.com/${repo.owner}/${repo.repo}/discussions) to connect with the community

We appreciate your contribution to making Power BI knowledge more accessible!` :
                `üëã Welcome to Power BI Nexus, @${creator}! Thanks for your first pull request.
                
A maintainer will review your changes soon. Please ensure:
- ‚úÖ You've filled out the PR template completely
- ‚úÖ All automated checks pass
- ‚úÖ You've provided sources for any new content
- ‚úÖ You've disclosed any relationship to suggested content

Thank you for contributing!`;
              
              await github.rest.issues.createComment({
                ...repo,
                issue_number: issue.number,
                body: welcomeMessage
              });
            }

  auto-assign:
    name: Auto-assign Labels and Reviewers
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Auto-assign based on content
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body.toLowerCase();
            
            let labels = ['needs-review'];
            
            // Auto-label based on content
            if (title.includes('[resource]') || body.includes('resource type')) {
              labels.push('resource-suggestion');
            }
            if (title.includes('[best practice]') || body.includes('best practice category')) {
              labels.push('best-practice');
            }
            if (title.includes('[bug]') || body.includes('broken link') || body.includes('typo')) {
              labels.push('bug');
              labels.push('priority/medium');
            }
            
            // Add area labels based on keywords
            if (body.includes('dax')) labels.push('area/dax');
            if (body.includes('modeling') || body.includes('data model')) labels.push('area/modeling');
            if (body.includes('tool')) labels.push('area/tools');
            if (body.includes('security')) labels.push('area/security');
            if (body.includes('deployment') || body.includes('cicd')) labels.push('area/deployment');
            if (body.includes('visual') || body.includes('report design')) labels.push('area/visualization');
            
            await github.rest.issues.addLabels({
              ...context.repo,
              issue_number: issue.number,
              labels: labels
            });

  stale-check:
    name: Check for Stale Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'labeled'
    steps:
      - name: Comment on needs-more-info
        uses: actions/github-script@v7
        if: github.event.label.name == 'needs-more-info'
        with:
          script: |
            const issue = context.payload.issue;
            
            const message = `‚ö†Ô∏è **Additional Information Needed**
            
This issue has been labeled as needing more information. Please provide the requested details within 30 days, or this issue will be automatically closed.

If you need help understanding what's needed, please ask in the comments or check our [Contributing Guidelines](../CONTRIBUTING.md).`;
            
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: issue.number,
              body: message
            });

  monthly-review-reminder:
    name: Monthly Review Reminder
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Create monthly review issue
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date();
            const month = today.toLocaleString('default', { month: 'long' });
            const year = today.getFullYear();
            
            await github.rest.issues.create({
              ...context.repo,
              title: `üìã Monthly Maintenance Review - ${month} ${year}`,
              body: `## Monthly Maintenance Tasks

This is an automated reminder for maintainers to complete monthly reviews.

### Tasks

- [ ] Review all issues labeled \`needs-review\`
- [ ] Follow up on issues labeled \`needs-more-info\` (close if no response in 30 days)
- [ ] Review automated link check report
- [ ] Review RSS freshness report
- [ ] Update or remove stale resources
- [ ] Thank active contributors
- [ ] Update any necessary documentation

### Reports

Check the following workflow runs for automated reports:
- [Link Check Results](../actions/workflows/monthly-maintenance.yml)
- [RSS Freshness Report](../actions/workflows/monthly-maintenance.yml)

### Open Issues Needing Review

[View all issues needing review](../issues?q=is%3Aissue+is%3Aopen+label%3Aneeds-review)

---
*This issue was automatically created. Mark tasks complete as you go, then close when finished.*`,
              labels: ['maintenance', 'automated']
            });
